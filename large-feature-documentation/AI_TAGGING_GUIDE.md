# AI Tag Generation Integration Guide

## Overview
Tags now support tracking whether they were created by humans or AI, with additional metadata for automated tagging systems.

## New Tag Fields

### Core Fields
- **`source`** (string): Origin of the tag
  - `'human'` - Created manually by a user (default)
  - `'ai'` - Generated by AI model
  - `'automated'` - Created by automated system
  - `'imported'` - Imported from external source

- **`auto_generated`** (boolean): Quick flag for automated tags
  - `true` - Tag was automatically generated
  - `false` - Tag was manually created (default)

### AI-Specific Fields
- **`confidence`** (float, 0.0-1.0): Confidence score for AI-generated tags
  - Example: `0.85` = 85% confidence
  - Only relevant for AI/automated tags
  
- **`model_name`** (string): Name/version of the AI model
  - Example: `"gpt-4"`, `"claude-3"`, `"custom-tagger-v2"`
  - Helps track which system generated the tag

### Verification Fields
- **`verified`** (boolean): Whether tag has been reviewed by a human
  - `true` - Verified/approved by human
  - `false` - Not yet verified (default)
  
- **`verified_by_id`** (integer): ID of user who verified the tag
- **`verified_at`** (datetime): When verification occurred

## API Usage

### Creating an AI-Generated Tag

```python
# Example: Your tagging microservice creates a tag
POST /api/wikis/{wiki_id}/tags
{
    "name": "machine-learning",
    "color": "#3B82F6",
    "source": "ai",
    "auto_generated": true,
    "confidence": 0.87,
    "model_name": "custom-tagger-v2.1"
}
```

### Creating a Human Tag
```python
# Default behavior - all fields optional except name
POST /api/wikis/{wiki_id}/tags
{
    "name": "important",
    "color": "#EF4444"
    # source defaults to 'human'
    # auto_generated defaults to false
    # verified defaults to false
}
```

### Verifying an AI Tag
```python
# Mark a tag as verified
POST /api/wikis/{wiki_id}/tags/{tag_id}/verify
# Automatically sets verified=true, verified_by_id=current_user, verified_at=now
```

### Updating Tag Metadata
```python
PATCH /api/wikis/{wiki_id}/tags/{tag_id}
{
    "confidence": 0.92,  # Update confidence score
    "verified": true     # Manual verification
}
```

## UI Indicators

### Visual Badges
- **Bot icon** (ðŸ¤–): Shown on AI-generated tags
  - Hover shows: model name and confidence score
- **User icon** (ðŸ‘¤): Shown on human-created tags
- **Check icon** (âœ“): Shown on verified tags
- **Green dot**: Small indicator on verified tags

### Tag Styling
- AI-generated tags have a subtle border and enhanced shadow
- Verified tags show a small green verification dot

## Integration with Tagging Microservice

### Recommended Workflow

1. **Tag Generation**
   ```python
   # Your microservice analyzes a page
   def analyze_page(page_content):
       tags = ai_model.generate_tags(page_content)
       
       for tag_name, confidence in tags:
           # Create tag in wiki
           create_tag({
               'name': tag_name,
               'color': assign_color(tag_name),
               'source': 'ai',
               'auto_generated': True,
               'confidence': confidence,
               'model_name': 'your-model-v1.0'
           })
   ```

2. **Batch Tagging**
   ```python
   # Process multiple pages
   POST /api/wikis/{wiki_id}/pages/{page_id}/tags/{tag_id}
   # Add each generated tag to relevant pages
   ```

3. **Human Review**
   - Users can verify AI tags through the UI
   - Or via API: `POST /api/wikis/{wiki_id}/tags/{tag_id}/verify`

### Filtering Tags

```python
# Get all AI-generated tags
tags = Tag.query.filter_by(
    wiki_id=wiki_id,
    auto_generated=True
).all()

# Get unverified AI tags
unverified = Tag.query.filter_by(
    wiki_id=wiki_id,
    auto_generated=True,
    verified=False
).all()

# Get high-confidence tags
high_conf = Tag.query.filter(
    Tag.wiki_id == wiki_id,
    Tag.confidence >= 0.8
).all()
```

## Future Enhancements to Consider

1. **Tag Suggestions**: Show AI-suggested tags before applying them
2. **Bulk Verification**: Verify multiple tags at once
3. **Confidence Threshold**: Only apply tags above certain confidence
4. **Model Comparison**: Track performance of different tagging models
5. **Active Learning**: Use verification data to improve AI model
6. **Tag Relationships**: Link related tags suggested together
7. **Versioning**: Track tag suggestion evolution over time

## Database Schema

```sql
-- Tags table now includes:
ALTER TABLE tags ADD COLUMN source VARCHAR(20) DEFAULT 'human';
ALTER TABLE tags ADD COLUMN auto_generated BOOLEAN DEFAULT FALSE;
ALTER TABLE tags ADD COLUMN confidence FLOAT;
ALTER TABLE tags ADD COLUMN model_name VARCHAR(100);
ALTER TABLE tags ADD COLUMN verified BOOLEAN DEFAULT FALSE;
ALTER TABLE tags ADD COLUMN verified_by_id INTEGER REFERENCES users(id);
ALTER TABLE tags ADD COLUMN verified_at TIMESTAMP;
```

## Example: Building a Tagging Microservice

```python
# tagging_service.py
import requests
from typing import List, Tuple

class TaggingService:
    def __init__(self, wiki_api_url: str, api_token: str, model_name: str):
        self.api_url = wiki_api_url
        self.headers = {'Authorization': f'Bearer {api_token}'}
        self.model_name = model_name
    
    def tag_page(self, wiki_id: int, page_id: int, content: str) -> List[dict]:
        """Generate and apply tags to a page."""
        # Generate tags using your AI model
        suggested_tags = self.generate_tags(content)
        
        applied_tags = []
        for tag_name, confidence in suggested_tags:
            # Create or get tag
            tag = self.get_or_create_tag(
                wiki_id=wiki_id,
                name=tag_name,
                confidence=confidence
            )
            
            # Apply to page
            self.add_tag_to_page(wiki_id, page_id, tag['id'])
            applied_tags.append(tag)
        
        return applied_tags
    
    def generate_tags(self, content: str) -> List[Tuple[str, float]]:
        """Your AI model logic here."""
        # Example: Call your ML model
        # Return list of (tag_name, confidence_score) tuples
        pass
    
    def get_or_create_tag(self, wiki_id: int, name: str, confidence: float) -> dict:
        """Get existing tag or create new AI-generated tag."""
        # Try to get existing tag
        response = requests.get(
            f'{self.api_url}/wikis/{wiki_id}/tags',
            headers=self.headers
        )
        tags = response.json()['tags']
        existing = next((t for t in tags if t['name'] == name), None)
        
        if existing:
            return existing
        
        # Create new tag
        response = requests.post(
            f'{self.api_url}/wikis/{wiki_id}/tags',
            headers=self.headers,
            json={
                'name': name,
                'color': self.generate_color(name),
                'source': 'ai',
                'auto_generated': True,
                'confidence': confidence,
                'model_name': self.model_name
            }
        )
        return response.json()['tag']
    
    def add_tag_to_page(self, wiki_id: int, page_id: int, tag_id: int):
        """Add tag to page."""
        requests.post(
            f'{self.api_url}/wikis/{wiki_id}/pages/{page_id}/tags/{tag_id}',
            headers=self.headers
        )
```

## Best Practices

1. **Set Appropriate Confidence Thresholds**: Don't apply tags with very low confidence (<0.5)
2. **Use Descriptive Model Names**: Include version numbers for tracking
3. **Encourage Verification**: Make it easy for users to verify/reject AI tags
4. **Monitor Performance**: Track which tags get verified vs. rejected
5. **Provide Transparency**: Always show users which tags are AI-generated
6. **Allow Override**: Let users easily remove incorrect AI tags
